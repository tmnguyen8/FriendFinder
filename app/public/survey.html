<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Survey Page</title>

  <!-- Latest compiled and minified CSS & JS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css">
  <script src="https://code.jquery.com/jquery.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

  <!-- Inline CSS Styling -->
  <link rel="stylesheet" href="./assets/css/style.css">



</head>

<body>


  <div class="container">

    <div class="jumbotron banner">
      <h1 class="text-center">
        <span class="fas fa-user-friends"></span>Friend Finder Survey</h1>
      <hr>
      <h2 class="text-center">Let us know a little about yourself</h2>
      <br>
      <div class="text-center">
        <a href="/">
          <button class="btn btn-lg btn-default">
            <span class="fa fa-home"></span>
          </button>
        </a>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-12">
        <!-- Survey Page -->
        <div class="card">
          <div class="card-header">
            Survey
          </div>
          <div class="card-body">
            <form role="form">
                <h3><strong>About You</strong></h3>
                <h4>Name (Required)</h4>
                <input type="text" id="name" class="form-control" required>

                <h4>Link to Photo Image (Required)</h4>
                <input type="text" id="photo" class="form-control" required>

                <hr>

                <h3><strong>Question 1</strong></h3>
                <h4>How physically big are you?</h4>
                <select class="form-control" id="q1">
                    <option value="0"></option>
                    <option value="1">I'm small and petite</option>
                    <option value="2">I'm smaller than most sturdily built</option>
                    <option value="3">I'm average</option>
                    <option value="4">I'm somewhat bigger than average</option>
                    <option value="5">I'm XL</option>
                </select>

                <h3><strong>Question 2</strong></h3>
                <h4>How aggressive are you?</h4>
                <select class="form-control" id="q2">
                    <option value="0"></option>
                    <option value="1">I'm shy and avoid confrontation</option>
                    <option value="2">I'm not a troublemaker</option>
                    <option value="3">I'm in the middle</option>
                    <option value="4">I'm a little stubborn but I can still listen</option>
                    <option value="5">Don't you dare mess with me</option>
                </select>


                <h3><strong>Question 3</strong></h3>
                <h4>How socialable are you?</h4>
                <select class="form-control" id="q3">
                    <option value="0"></option>
                    <option value="1">I'm generally self-contained</option>
                    <option value="2">I prefer small group of people</option>
                    <option value="3">I'm in the middle</option>
                    <option value="4">I'm outgoing</option>
                    <option value="5">I'm a social bird</option>
                </select>


                <h3><strong>Question 4</strong></h3>
                <h4>How attractive do you think you are? (1 is the least attractive and 5 is highly attractive)</h4>
                <select class="form-control" id="q4">
                    <option value="0"></option>
                    <option value="1">1 (least)</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5 (highest)</option>
                </select>


                <h3><strong>Question 5</strong></h3>
                <h4>How creative are you? (1 is the least creative and 5 is highly creative)</h4>
                <select class="form-control" id="q5">
                    <option value="0"></option>
                    <option value="1">1 (least)</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5 (highest)</option>
                </select>


                <h3><strong>Question 6</strong></h3>
                <h4>Your selflessness and cooperation level</h4>
                <select class="form-control" id="q6">
                    <option value="0"></option>
                    <option value="1">1 (least)</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5 (highest)</option>
                </select>


                <h3><strong>Question 7</strong></h3>
                <h4>How intelligent are you?</h4>
                <select class="form-control" id="q7">
                    <option value="0"></option>
                    <option value="1">1 (least)</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5 (highest)</option>
                </select>

                <h3><strong>Question 8</strong></h3>
                <h4>How athletic are you?</h4>
                <select class="form-control" id="q8">
                    <option value="0"></option>
                    <option value="1">1 (least)</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5 (highest)</option>
                </select>

                <h3><strong>Question 9</strong></h3>
                <h4>You think that everyoneâ€™s views should be respected regardless of whether they are supported by facts or not.</h4>
                <select class="form-control" id="q9">
                    <option value="0"></option>
                    <option value="1">1 (Strongly Disagree)</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5 (Strongly Agree)</option>
                </select>

                <h3><strong>Question 10</strong></h3>
                <h4>You feel more energetic after spending time with a group of people.</h4>
                <select class="form-control" id="q10">
                    <option value="0"></option>
                    <option value="1">1 (Strongly Disagree)</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5 (Strongly Agree)</option>
                </select>

                <hr>
                <button type="submit" class="btn btn-primary submit" >Submit</button>
            </form>
      
            <!-- Modal -->
            <div class="modal fade" id="result-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Your Best Match is:</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    </div>
                    <div class="modal-body">
                        <p class="result-name"></p>
                        <img src="" class="result-img" alt="result-image">
                    </div>
                    <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
                </div>
            </div>


          </div>
        </div>
      </div>
    </div>


    <footer class="footer">
      <div class="container">
        <p>
          <a href="/api/friends">API Friends Link</a> 
      </div>
    </footer>

  </div>

</body>

</html>

<!-- BELOW CODE IS CRITICAL. IT HANDLES HOW FORM DATA IS SENT TO OUR SERVER -->
<script type="text/javascript">
  // In this code below we create the Front-end JavaScript which "POSTS" our form data to our express server.
  // In essence, when the user hits submit, jQuery grabs all of the fields then sends a post request to our api
  // Our api recognizes the route (/api/tables)... and then runs the associated code (found in api-routes.js).
  // In this case the associated code "saves" the data to the table-data.js file or waitinglist-data.js file

    $(".submit").on("click", function(event) {
    event.preventDefault();

    // Validate the form
    function validateForm() {
        var isValid = true;
        // Check if any of the answers are blank
        $('.form-control').each(function() {
            if($(this).val() === "0") {
                isValid = false;
            };
        });
        return isValid;
    };

    // If the form is filled out (validateForm is true)
    // Add the answers into an object to post to data
    if (validateForm()) {
        // Create an object for the user"s data
        var userData = {
          name: $("#name").val(),
          photo: $("#photo").val(),
          scores: [
            $("#q1").val(),
            $("#q2").val(),
            $("#q3").val(),
            $("#q4").val(),
            $("#q5").val(),
            $("#q6").val(),
            $("#q7").val(),
            $("#q8").val(),
            $("#q9").val(),
            $("#q10").val()
          ]
        };

        // function to know the total scores and added it as a value:key in userData
        function sumScore(scoresArr) {
            var total = 0;
                for (i of scoresArr) {
                    total += parseInt(i);
                }
            return total;
        }
        // add totalScore to userData object as a parameter (this will be used to compare the best match)
        userData.totalScore = sumScore(userData.scores);
        // console.log('userScore', userData.scores)
        
        // console.log("totalScore",userData.totalScore)
        // Get all of the friends from API to find the closest totalScore to match with user's totalScore
        $.get("/api/friends").then(function(friendData) {
            var friendScores = [];

            // Loop through each of the friend and push their scores into friendScores
            for (i of friendData){
                friendScores.push(parseInt(i.totalScore))
            };

            // Find the closest totalScore to user's totalScore
            function findClosest(num,arr) {
                var diffArr = [];
                for (i of arr) {
                    diffArr.push(Math.abs(num-i))
                };
                return diffArr.indexOf(Math.min(...diffArr));
            };

            var closestFriendIndex = findClosest(userData.totalScore, friendScores);

            // find the best matched with the closest totalScore
            function findBestMatched(score){
                for (i of friendData) {
                    if(i.totalScore === score) {
                        return [i.name, i.photo, i.totalScore]
                    }
                }
            };
            var bestMatch = friendData[closestFriendIndex];
            
            // Show the photos of best match in modal
            $(".result-name").text(bestMatch.name);
            $(".result-img").attr("src", bestMatch.photo);

            // Show the modal with the best match
            $("#result-modal").modal("toggle");

            // testing and debugging
            console.log("all of friends scores", friendScores);
            console.log("user score", userData.totalScore)
            console.log("best match index", closestFriendIndex);
            console.log("this is the best match: ",bestMatch);
        });

        $.post("/api/friends", userData, function(data) {
            console.log("post successful")
        });
    } else {
        // console.log("incomplete form")
        $(".result-name").text("Incomplete form");
        $(".result-img").attr("src", "https://i.pinimg.com/originals/32/3e/3b/323e3b47f07fa1fb0a4b2ecb03b2c965.png");

        // Show the modal with the best match
        $("#result-modal").modal("toggle");
    }
});
</script>
